"use strict";(self.webpackChunkflowervalley=self.webpackChunkflowervalley||[]).push([[9],{3009:(Ot,q,d)=>{d.r(q),d.d(q,{OrdersModule:()=>yt});var m=d(9808),T=d(2535),A=d(135),W=d(8372),e=d(5e3),P=d(9274),a=d(3075),b=d(9783),O=d(1424),B=d(8689),f=d(4255),C=d(845);function K(n,u){1&n&&e.GkF(0)}const X=function(n){return{"p-disabled":n}};function ee(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",3),e.NdJ("click",function(o){return e.CHM(t),e.oxw().onActivateClick(o)})("keydown",function(o){return e.CHM(t),e.oxw().onKeydown(o)}),e.Hsn(1),e.YNc(2,K,1,0,"ng-container",4),e.qZA()}if(2&n){const t=e.oxw();e.Q6J("ngClass",e.VKq(2,X,t.disabled)),e.xp6(2),e.Q6J("ngTemplateOutlet",t.displayTemplate)}}function te(n,u){1&n&&e.GkF(0)}function ne(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"button",7),e.NdJ("click",function(o){return e.CHM(t),e.oxw(2).onDeactivateClick(o)}),e.qZA()}if(2&n){const t=e.oxw(2);e.Q6J("icon",t.closeIcon)}}function ie(n,u){if(1&n&&(e.TgZ(0,"div",5),e.Hsn(1,1),e.YNc(2,te,1,0,"ng-container",4),e.YNc(3,ne,1,1,"button",6),e.qZA()),2&n){const t=e.oxw();e.xp6(2),e.Q6J("ngTemplateOutlet",t.contentTemplate),e.xp6(1),e.Q6J("ngIf",t.closable)}}const oe=[[["","pInplaceDisplay",""]],[["","pInplaceContent",""]]],re=function(n){return{"p-inplace p-component":!0,"p-inplace-closable":n}},ue=["[pInplaceDisplay]","[pInplaceContent]"];let F=(()=>{class n{constructor(t){this.cd=t,this.closeIcon="pi pi-times",this.onActivate=new e.vpe,this.onDeactivate=new e.vpe}ngAfterContentInit(){this.templates.forEach(t=>{switch(t.getType()){case"display":this.displayTemplate=t.template;break;case"content":this.contentTemplate=t.template}})}onActivateClick(t){this.preventClick||this.activate(t)}onDeactivateClick(t){this.preventClick||this.deactivate(t)}activate(t){this.disabled||(this.active=!0,this.onActivate.emit(t),this.cd.markForCheck())}deactivate(t){this.disabled||(this.active=!1,this.hover=!1,this.onDeactivate.emit(t),this.cd.markForCheck())}onKeydown(t){13===t.which&&(this.activate(t),t.preventDefault())}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(e.sBO))},n.\u0275cmp=e.Xpm({type:n,selectors:[["p-inplace"]],contentQueries:function(t,i,o){if(1&t&&e.Suo(o,b.jx,4),2&t){let r;e.iGM(r=e.CRH())&&(i.templates=r)}},hostAttrs:[1,"p-element"],inputs:{active:"active",closable:"closable",disabled:"disabled",preventClick:"preventClick",style:"style",styleClass:"styleClass",closeIcon:"closeIcon"},outputs:{onActivate:"onActivate",onDeactivate:"onDeactivate"},ngContentSelectors:ue,decls:3,vars:8,consts:[[3,"ngClass","ngStyle"],["class","p-inplace-display","tabindex","0",3,"ngClass","click","keydown",4,"ngIf"],["class","p-inplace-content",4,"ngIf"],["tabindex","0",1,"p-inplace-display",3,"ngClass","click","keydown"],[4,"ngTemplateOutlet"],[1,"p-inplace-content"],["type","button","pButton","",3,"icon","click",4,"ngIf"],["type","button","pButton","",3,"icon","click"]],template:function(t,i){1&t&&(e.F$t(oe),e.TgZ(0,"div",0),e.YNc(1,ee,3,4,"div",1),e.YNc(2,ie,4,2,"div",2),e.qZA()),2&t&&(e.Tol(i.styleClass),e.Q6J("ngClass",e.VKq(6,re,i.closable))("ngStyle",i.style),e.xp6(1),e.Q6J("ngIf",!i.active),e.xp6(1),e.Q6J("ngIf",i.active))},directives:[m.mk,m.PC,m.O5,m.tP,C.Hq],styles:[".p-inplace .p-inplace-display{display:inline;cursor:pointer}.p-inplace .p-inplace-content{display:inline}.p-fluid .p-inplace.p-inplace-closable .p-inplace-content{display:flex}.p-fluid .p-inplace.p-inplace-closable .p-inplace-content>.p-inputtext{flex:1 1 auto;width:1%}\n"],encapsulation:2,changeDetection:0}),n})(),se=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[m.ez,C.hJ],C.hJ]}),n})();function ce(n,u){if(1&n&&e._UZ(0,"span",3),2&n){const t=e.oxw();e.Q6J("ngClass",t.icon)}}const de=["*"];let J=(()=>{class n{containerClass(){return{"p-tag p-component":!0,"p-tag-info":"info"===this.severity,"p-tag-success":"success"===this.severity,"p-tag-warning":"warning"===this.severity,"p-tag-danger":"danger"===this.severity,"p-tag-rounded":this.rounded}}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=e.Xpm({type:n,selectors:[["p-tag"]],hostAttrs:[1,"p-element"],inputs:{styleClass:"styleClass",style:"style",severity:"severity",value:"value",icon:"icon",rounded:"rounded"},ngContentSelectors:de,decls:5,vars:6,consts:[[3,"ngClass","ngStyle"],["class","p-tag-icon",3,"ngClass",4,"ngIf"],[1,"p-tag-value"],[1,"p-tag-icon",3,"ngClass"]],template:function(t,i){1&t&&(e.F$t(),e.TgZ(0,"span",0),e.Hsn(1),e.YNc(2,ce,1,1,"span",1),e.TgZ(3,"span",2),e._uU(4),e.qZA()()),2&t&&(e.Tol(i.styleClass),e.Q6J("ngClass",i.containerClass())("ngStyle",i.style),e.xp6(2),e.Q6J("ngIf",i.icon),e.xp6(2),e.Oqu(i.value))},directives:[m.mk,m.PC,m.O5],styles:[".p-tag{display:inline-flex;align-items:center;justify-content:center}.p-tag-icon,.p-tag-value,.p-tag-icon.pi{line-height:1.5}.p-tag.p-tag-rounded{border-radius:10rem}\n"],encapsulation:2,changeDetection:0}),n})(),le=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[m.ez]]}),n})();var D=d(4036),ae=d(9047),I=d(6497);function pe(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",9)(1,"div"),e._uU(2,"\u0421\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u043a\u0430\u0437\u043e\u0432"),e.qZA(),e.TgZ(3,"p-button",10),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().newOrder()}),e.qZA()()}}function _e(n,u){1&n&&(e.TgZ(0,"tr")(1,"th"),e._uU(2,"\u041d\u043e\u043c\u0435\u0440 \u0437\u0430\u043a\u0430\u0437\u0430"),e.qZA(),e.TgZ(3,"th"),e._uU(4,"\u0414\u0430\u0442\u0430 \u0437\u0430\u043a\u0430\u0437\u0430"),e.qZA(),e.TgZ(5,"th"),e._uU(6,"\u041a\u043b\u0438\u0435\u043d\u0442"),e.qZA(),e.TgZ(7,"th"),e._uU(8,"\u0414\u0430\u043d\u043d\u044b\u0435 \u043a\u043b\u0438\u0435\u043d\u0442\u0430"),e.qZA(),e.TgZ(9,"th"),e._uU(10,"\u0410\u0434\u0440\u0435\u0441 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA(),e.TgZ(11,"th"),e._uU(12,"\u0421\u0443\u043c\u043c\u0430 \u0437\u0430\u043a\u0430\u0437\u0430"),e.qZA(),e.TgZ(13,"th"),e._uU(14,"\u0421\u0442\u0430\u0442\u0443\u0441"),e.qZA(),e.TgZ(15,"th"),e._uU(16,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044f"),e.qZA()())}function me(n,u){if(1&n&&(e.TgZ(0,"div"),e._uU(1),e.qZA()),2&n){const t=e.oxw().$implicit;e.xp6(1),e.hij("\u0418\u041d\u041d: ",t.clientInn,"")}}function ge(n,u){if(1&n&&e._UZ(0,"p-tag",17),2&n){const t=e.oxw().$implicit,i=e.oxw();e.Q6J("value",i.getStatus(t.status).label)("severity",i.getStatus(t.status).severity)}}function he(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-dropdown",18),e.NdJ("onChange",function(){e.CHM(t);const o=e.oxw().$implicit,r=e.MAs(19);return e.oxw().changeStatus(o,r)})("ngModelChange",function(o){return e.CHM(t),e.oxw().$implicit.status=o}),e.qZA()}if(2&n){const t=e.oxw().$implicit,i=e.oxw();e.Q6J("options",i.statusDropdown)("autoDisplayFirst",!1)("ngModel",t.status)}}function ve(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"tr")(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td"),e._uU(4),e.ALo(5,"date"),e.qZA(),e.TgZ(6,"td"),e._uU(7),e.qZA(),e.TgZ(8,"td"),e.YNc(9,me,2,1,"div",11),e.TgZ(10,"div"),e._uU(11),e.qZA()(),e.TgZ(12,"td"),e._uU(13),e.qZA(),e.TgZ(14,"td"),e._uU(15),e.ALo(16,"priceConverter"),e.qZA(),e.TgZ(17,"td")(18,"p-inplace",null,12),e.YNc(20,ge,1,2,"ng-template",13),e.YNc(21,he,1,3,"ng-template",14),e.qZA()(),e.TgZ(22,"td")(23,"button",15),e.NdJ("click",function(){const r=e.CHM(t).$implicit;return e.oxw().repeatOrder(r.id)}),e.qZA(),e.TgZ(24,"button",16),e.NdJ("click",function(){const r=e.CHM(t).$implicit;return e.oxw().showOrder(r.id)}),e.qZA()()()}if(2&n){const t=u.$implicit;e.xp6(2),e.Oqu(t.id),e.xp6(2),e.Oqu(e.xi3(5,7,t.orderDate,"dd.MM.yyyy HH:mm")),e.xp6(3),e.Oqu(t.clientName),e.xp6(2),e.Q6J("ngIf",t.clientInn),e.xp6(2),e.hij("\u041f\u043e\u0447\u0442\u0430: ",t.clientEmail,""),e.xp6(2),e.Oqu(t.clientAddress),e.xp6(2),e.Oqu(e.xi3(16,10,t.orderSum,"two"))}}function fe(n,u){1&n&&e._UZ(0,"flower-valley-loader",19)}let be=(()=>{class n{constructor(t,i,o,r,s){this.orderService=t,this.fb=i,this.cs=o,this.ms=r,this.router=s,this.orders=[],this.statusDropdown=A.hm,this.skip=0,this.isLoading=!1,this.searchString="",this.searchControl=i.control(""),this.searchControl.valueChanges.pipe((0,W.b)(1e3)).subscribe(c=>{this.searchString=c,this.skip=0,this.orders=[],this.getOrders()})}ngOnInit(){window.scrollTo(0,1),window.scrollTo(0,0)}getOrders(){this.isLoading=!0,this.orderService.getItems(this.skip,10,this.searchString).subscribe(t=>{this.orders=this.orders.concat(t),this.skip+=10,this.isLoading=!1})}showOrder(t){this.router.navigate(["admin/orders",t])}repeatOrder(t){this.router.navigate(["admin/orders/create"],{queryParams:{orderId:t}})}newOrder(){this.router.navigate(["admin/orders/create"])}getStatus(t){return(0,A.SX)(t)}changeStatus(t,i){this.orderService.updateItem({id:t.id,status:t.status}).subscribe(),i.deactivate(),this.ms.add({severity:"success",summary:"\u0417\u0430\u043a\u0430\u0437 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d",detail:`\u0417\u0430\u043a\u0430\u0437\u0443 \u2116${t.id} \u043f\u0440\u0438\u0441\u0432\u043e\u0435\u043d \u0441\u0442\u0430\u0442\u0443\u0441 ${this.getStatus(t.status).label}`})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(P.p),e.Y36(a.qu),e.Y36(b.YP),e.Y36(b.ez),e.Y36(T.F0))},n.\u0275cmp=e.Xpm({type:n,selectors:[["flower-valley-orders"]],decls:10,vars:3,consts:[[1,"p-float-label","mt-2"],["type","text","id","search","pInputText","",3,"formControl"],["for","search"],["infinite-scroll","",3,"scrolled"],["styleClass","mt-2",3,"value"],["pTemplate","caption"],["pTemplate","header"],["pTemplate","body"],["appearance","small",4,"ngIf"],[1,"flex","justify-content-between","align-items-center"],["label","\u041d\u043e\u0432\u044b\u0439 \u0437\u0430\u043a\u0430\u0437",3,"onClick"],[4,"ngIf"],["inplace",""],["pTemplate","display"],["pTemplate","content"],["pButton","","type","button","icon","pi pi-sync",1,"p-button-rounded","p-button-info","p-button-text",3,"click"],["pButton","","type","button","icon","pi pi-eye",1,"p-button-rounded","p-button-text","p-button-success",3,"click"],[3,"value","severity"],["placeholder","\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u0443\u0441","optionLabel","name","optionValue","value",3,"options","autoDisplayFirst","ngModel","onChange","ngModelChange"],["appearance","small"]],template:function(t,i){1&t&&(e.TgZ(0,"span",0),e._UZ(1,"input",1),e.TgZ(2,"label",2),e._uU(3,"\u041d\u043e\u043c\u0435\u0440 \u0437\u0430\u043a\u0430\u0437\u0430, \u0418\u041d\u041d, \u0438\u043c\u044f, \u043f\u043e\u0447\u0442\u0430 \u0438\u043b\u0438 \u043d\u043e\u043c\u0435\u0440 \u0442\u0435\u043b\u0435\u0444\u043e\u043d\u0430"),e.qZA()(),e.TgZ(4,"div",3),e.NdJ("scrolled",function(){return i.getOrders()}),e.TgZ(5,"p-table",4),e.YNc(6,pe,4,0,"ng-template",5),e.YNc(7,_e,17,0,"ng-template",6),e.YNc(8,ve,25,13,"ng-template",7),e.qZA()(),e.YNc(9,fe,1,0,"flower-valley-loader",8)),2&t&&(e.xp6(1),e.Q6J("formControl",i.searchControl),e.xp6(4),e.Q6J("value",i.orders),e.xp6(4),e.Q6J("ngIf",i.isLoading))},directives:[a.Fj,O.o,a.JJ,a.oH,B.R,f.iA,b.jx,C.zx,m.O5,F,J,D.Lt,a.On,C.Hq,ae.R],pipes:[m.uU,I.K],styles:[""]}),n})();var Z=(()=>{return(n=Z||(Z={}))[n.UpGrade=0]="UpGrade",n[n.DownGrade=1]="DownGrade",Z;var n})(),w=d(9106),k=d(6827);let U=(()=>{class n{convert(t){const i=t,[o,r,s,c,p,l,_]=i.match(/\d+/g);return new Date(Date.UTC(o,r-1,s,c,p,l,_))}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:null}),n})();var M=d(3248),N=d(4004),Y=d(4128),Q=d(5995),H=d(3878),Ce=d(7216),j=d(5055),R=d(5652),S=d(7780),E=d(3787),$=d(9272);function xe(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",9),e.NdJ("onClick",function(){return e.CHM(t),e.oxw(2).showProductsDropdown()}),e.qZA()}if(2&n){const t=e.oxw(2);e.Q6J("loading",t.isProductsLoading)}}function ye(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-dropdown",10),e.NdJ("onHide",function(){return e.CHM(t),e.oxw(2).showProductSelect=!1})("onChange",function(o){return e.CHM(t),e.oxw(2).addProduct(o.value)}),e.qZA()}if(2&n){const t=e.oxw(2);e.Q6J("filter",!0)("options",t.products)("autoDisplayFirst",!1)}}function Te(n,u){if(1&n&&(e.TgZ(0,"div",4)(1,"div"),e._uU(2,"\u0421\u043f\u0438\u0441\u043e\u043a \u0442\u043e\u0432\u0430\u0440\u043e\u0432"),e.qZA(),e.TgZ(3,"div",5)(4,"div",6),e.YNc(5,xe,1,1,"p-button",7),e.YNc(6,ye,1,3,"p-dropdown",8),e.qZA()()()),2&n){const t=e.oxw();e.xp6(5),e.Q6J("ngIf",!t.showProductSelect),e.xp6(1),e.Q6J("ngIf",t.showProductSelect)}}function Ze(n,u){1&n&&(e.TgZ(0,"tr")(1,"th"),e._uU(2,"\u0422\u043e\u0432\u0430\u0440"),e.qZA(),e.TgZ(3,"th"),e._uU(4,"\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e"),e.qZA(),e.TgZ(5,"th"),e._uU(6,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c"),e.qZA(),e.TgZ(7,"th"),e._uU(8,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044f"),e.qZA()())}function Oe(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"input",18),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw().$implicit.product.name=o}),e.qZA()}if(2&n){const t=e.oxw().$implicit;e.Q6J("ngModel",t.product.name)}}function Ie(n,u){if(1&n&&e._uU(0),2&n){const t=e.oxw().$implicit;e.hij(" ",t.product.name," ")}}function we(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-inputNumber",19),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw().$implicit.count=o}),e.qZA()}if(2&n){const t=e.oxw().$implicit;e.Q6J("ngModel",t.count)("min",t.product.coefficient)("required",!0)}}function Ae(n,u){if(1&n&&e._uU(0),2&n){const t=e.oxw().$implicit;e.hij(" ",t.count," ")}}function De(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-inputNumber",20),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw().$implicit.price=o}),e.qZA()}if(2&n){const t=e.oxw().$implicit;e.Q6J("ngModel",t.price)("min",1)("maxFractionDigits",2)("required",!0)}}function Me(n,u){if(1&n&&e._uU(0),2&n){const t=e.oxw().$implicit;e.hij(" ",t.price," ")}}function Se(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",21),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().onRowEditInit(o)}),e.qZA()}}function Pe(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",22),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(),r=o.$implicit,s=o.rowIndex;return e.oxw().deleteProduct(r,s)}),e.qZA()}}function Ne(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",23),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(),r=o.$implicit,s=o.rowIndex;return e.oxw().onRowEditSave(r,s)}),e.qZA()}}function Ee(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",24),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(),r=o.$implicit,s=o.rowIndex;return e.oxw().onRowEditCancel(r,s)}),e.qZA()}}function qe(n,u){if(1&n&&(e.TgZ(0,"tr",11)(1,"td")(2,"p-cellEditor"),e.YNc(3,Oe,1,1,"ng-template",12),e.YNc(4,Ie,1,1,"ng-template",13),e.qZA()(),e.TgZ(5,"td")(6,"p-cellEditor"),e.YNc(7,we,1,3,"ng-template",12),e.YNc(8,Ae,1,1,"ng-template",13),e.qZA()(),e.TgZ(9,"td")(10,"p-cellEditor"),e.YNc(11,De,1,4,"ng-template",12),e.YNc(12,Me,1,1,"ng-template",13),e.qZA()(),e.TgZ(13,"td"),e.YNc(14,Se,1,0,"p-button",14),e.YNc(15,Pe,1,0,"p-button",15),e.YNc(16,Ne,1,0,"p-button",16),e.YNc(17,Ee,1,0,"p-button",17),e.qZA()()),2&n){const i=u.editing;e.Q6J("pEditableRow",u.$implicit),e.xp6(14),e.Q6J("ngIf",!i),e.xp6(1),e.Q6J("ngIf",!i),e.xp6(1),e.Q6J("ngIf",i),e.xp6(1),e.Q6J("ngIf",i)}}let L=(()=>{class n{constructor(t,i,o){this.productService=t,this.cs=i,this.cdr=o,this._orderProducts=[],this.isNewOrder=!1,this.orderProductsChange=new e.vpe,this.clonedProducts={},this.products=[],this.hiddedProducts=[],this.isProductsLoading=!1,this.showProductSelect=!1}get orderProducts(){return this._orderProducts}set orderProducts(t){this._orderProducts=t,this.orderProductsChange.emit(this.orderProducts)}ngOnChanges(t){const i=t.orderProducts.currentValue;i&&this.getProducts(i,!1)}showProductsDropdown(){this.products.length?this.showProductSelect=!0:this.getProducts(this.orderProducts,!0)}getProducts(t,i){this.isProductsLoading=!0,this.productService.getItems().subscribe(o=>{t.map(r=>{const s=o.findIndex(p=>p.id===r.product.id),c=o[s];this.hiddedProducts.push(c),o.splice(s,1),this.isNewOrder&&(r.price=c.price),c.categoryId&&c.categoryName&&(r.product.category={id:c.categoryId,name:c.categoryName})}),this.products=o,this.isProductsLoading=!1,i&&(this.showProductSelect=!0)})}addProduct(t){this.orderProducts.push({id:t.id,count:Number(t.coefficient),price:t.price,product:t}),this.showProductSelect=!1;const i=this.products.findIndex(o=>o.id===t.id);this.products.splice(i,1),this.hiddedProducts.push(t)}onRowEditInit(t){this.clonedProducts[t.id]=Object.assign({},t)}onRowEditSave(t,i){this.orderProducts[i]=t,delete this.clonedProducts[t.id]}onRowEditCancel(t,i){this.orderProducts[i]=this.clonedProducts[t.id],delete this.clonedProducts[t.id]}deleteProduct(t,i){this.cs.confirm({header:"\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u0435 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0442\u043e\u0432\u0430\u0440\u0430",message:"\u0412\u044b \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0445\u043e\u0442\u0438\u0442\u0435 \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0442\u043e\u0432\u0430\u0440 \u0438\u0437 \u0437\u0430\u043a\u0430\u0437\u0430?",accept:()=>{this.orderProducts.splice(i,1);const o=this.hiddedProducts.find(r=>r.id===t.product.id);o&&(this.products.push(o),this.cdr.detectChanges())}})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36($.M),e.Y36(b.YP),e.Y36(e.sBO))},n.\u0275cmp=e.Xpm({type:n,selectors:[["flower-valley-products-order"]],inputs:{isNewOrder:"isNewOrder",orderProducts:"orderProducts"},outputs:{orderProductsChange:"orderProductsChange"},features:[e.TTD],decls:4,vars:1,consts:[["editMode","row","dataKey","id",3,"value"],["pTemplate","caption"],["pTemplate","header"],["pTemplate","body"],[1,"flex","justify-content-between","align-items-center"],[1,"flex"],[1,"ml-2"],["label","\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0442\u043e\u0432\u0430\u0440",3,"loading","onClick",4,"ngIf"],["filterBy","name","placeholder","\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0442\u043e\u0432\u0430\u0440","optionLabel","name",3,"filter","options","autoDisplayFirst","onHide","onChange",4,"ngIf"],["label","\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0442\u043e\u0432\u0430\u0440",3,"loading","onClick"],["filterBy","name","placeholder","\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0442\u043e\u0432\u0430\u0440","optionLabel","name",3,"filter","options","autoDisplayFirst","onHide","onChange"],[3,"pEditableRow"],["pTemplate","input"],["pTemplate","output"],["pInitEditableRow","","styleClass","p-button-rounded p-button-text","icon","pi pi-pencil",3,"click",4,"ngIf"],["styleClass","p-button-rounded p-button-text p-button-danger","icon","pi pi-trash",3,"click",4,"ngIf"],["pSaveEditableRow","","icon","pi pi-check","styleClass","p-button-rounded p-button-text p-button-success p-mr-2",3,"click",4,"ngIf"],["pCancelEditableRow","","icon","pi pi-times","styleClass","p-button-rounded p-button-text p-button-danger",3,"click",4,"ngIf"],["pInputText","","type","text","required","",3,"ngModel","ngModelChange"],[3,"ngModel","min","required","ngModelChange"],[3,"ngModel","min","maxFractionDigits","required","ngModelChange"],["pInitEditableRow","","styleClass","p-button-rounded p-button-text","icon","pi pi-pencil",3,"click"],["styleClass","p-button-rounded p-button-text p-button-danger","icon","pi pi-trash",3,"click"],["pSaveEditableRow","","icon","pi pi-check","styleClass","p-button-rounded p-button-text p-button-success p-mr-2",3,"click"],["pCancelEditableRow","","icon","pi pi-times","styleClass","p-button-rounded p-button-text p-button-danger",3,"click"]],template:function(t,i){1&t&&(e.TgZ(0,"p-table",0),e.YNc(1,Te,7,2,"ng-template",1),e.YNc(2,Ze,9,0,"ng-template",2),e.YNc(3,qe,18,5,"ng-template",3),e.qZA()),2&t&&e.Q6J("value",i.orderProducts)},directives:[f.iA,b.jx,m.O5,C.zx,D.Lt,f.D$,f.YL,a.Fj,O.o,a.Q7,a.JJ,a.On,S.R,f.Pv,f.U1,f.wT],styles:[""]}),n})();var V=d(8812);function Be(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",4)(1,"div"),e._uU(2,"\u0421\u043f\u0438\u0441\u043e\u043a \u043a\u043e\u0440\u043e\u0431\u043e\u043a"),e.qZA(),e.TgZ(3,"p-button",5),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().regenerateBoxes()}),e.qZA()()}}function Fe(n,u){1&n&&(e.TgZ(0,"tr")(1,"th"),e._uU(2,"\u041a\u043e\u0440\u043e\u0431\u043a\u0430"),e.qZA(),e.TgZ(3,"th"),e._uU(4,"\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e"),e.qZA(),e.TgZ(5,"th"),e._uU(6,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c"),e.qZA(),e.TgZ(7,"th"),e._uU(8,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044f"),e.qZA()())}function Je(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-inputNumber",12),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw().$implicit.price=o}),e.qZA()}if(2&n){const t=e.oxw().$implicit;e.Q6J("ngModel",t.price)("min",0)("maxFractionDigits",2)("required",!0)}}function ke(n,u){if(1&n&&e._uU(0),2&n){const t=e.oxw().$implicit;e.hij(" ",t.price," ")}}function Ue(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",13),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().onRowEditInit(o)}),e.qZA()}}function Ye(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",14),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(),r=o.$implicit,s=o.rowIndex;return e.oxw().onRowEditSave(r,s)}),e.qZA()}}function Qe(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",15),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(),r=o.$implicit,s=o.rowIndex;return e.oxw().onRowEditCancel(r,s)}),e.qZA()}}function He(n,u){if(1&n&&(e.TgZ(0,"tr",6)(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td"),e._uU(4),e.qZA(),e.TgZ(5,"td")(6,"p-cellEditor"),e.YNc(7,Je,1,4,"ng-template",7),e.YNc(8,ke,1,1,"ng-template",8),e.qZA()(),e.TgZ(9,"td"),e.YNc(10,Ue,1,0,"p-button",9),e.YNc(11,Ye,1,0,"p-button",10),e.YNc(12,Qe,1,0,"p-button",11),e.qZA()()),2&n){const t=u.$implicit,i=u.editing;e.Q6J("pEditableRow",t),e.xp6(2),e.hij(" ",t.box.name," "),e.xp6(2),e.Oqu(t.count),e.xp6(6),e.Q6J("ngIf",!i),e.xp6(1),e.Q6J("ngIf",i),e.xp6(1),e.Q6J("ngIf",i)}}let G=(()=>{class n{constructor(t){this.boxService=t,this._orderBoxes=[],this.orderBoxesChange=new e.vpe,this.products=[],this.clonedBoxes={}}get orderBoxes(){return this._orderBoxes}set orderBoxes(t){this._orderBoxes=t,this.orderBoxesChange.emit(this.orderBoxes)}regenerateBoxes(){const t=this.products.map(i=>Object.assign(Object.assign({},i.product),{count:i.count,initialPrice:i.price}));t&&(this.boxService.genBoxes(t),this.boxService.getBoxes().subscribe(i=>{this.orderBoxes=i.map(o=>({id:o.id,count:o.count,price:o.price,box:o}))}))}onRowEditInit(t){this.clonedBoxes[t.id]=Object.assign({},t)}onRowEditSave(t,i){this.orderBoxes[i]=t,delete this.clonedBoxes[t.id]}onRowEditCancel(t,i){this.orderBoxes[i]=this.clonedBoxes[t.id],delete this.clonedBoxes[t.id]}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(V.r))},n.\u0275cmp=e.Xpm({type:n,selectors:[["flower-valley-boxes-order"]],inputs:{orderBoxes:"orderBoxes",products:"products"},outputs:{orderBoxesChange:"orderBoxesChange"},features:[e._Bn([V.r])],decls:4,vars:1,consts:[["editMode","row","dataKey","id",3,"value"],["pTemplate","caption"],["pTemplate","header"],["pTemplate","body"],[1,"flex","justify-content-between","align-items-center"],["label","\u041f\u0435\u0440\u0435\u0441\u0447\u0438\u0442\u0430\u0442\u044c \u043a\u043e\u0440\u043e\u0431\u043a\u0438",3,"onClick"],[3,"pEditableRow"],["pTemplate","input"],["pTemplate","output"],["pInitEditableRow","","styleClass","p-button-rounded p-button-text","icon","pi pi-pencil",3,"click",4,"ngIf"],["pSaveEditableRow","","icon","pi pi-check","styleClass","p-button-rounded p-button-text p-button-success p-mr-2",3,"click",4,"ngIf"],["pCancelEditableRow","","icon","pi pi-times","styleClass","p-button-rounded p-button-text p-button-danger",3,"click",4,"ngIf"],[3,"ngModel","min","maxFractionDigits","required","ngModelChange"],["pInitEditableRow","","styleClass","p-button-rounded p-button-text","icon","pi pi-pencil",3,"click"],["pSaveEditableRow","","icon","pi pi-check","styleClass","p-button-rounded p-button-text p-button-success p-mr-2",3,"click"],["pCancelEditableRow","","icon","pi pi-times","styleClass","p-button-rounded p-button-text p-button-danger",3,"click"]],template:function(t,i){1&t&&(e.TgZ(0,"p-table",0),e.YNc(1,Be,4,0,"ng-template",1),e.YNc(2,Fe,9,0,"ng-template",2),e.YNc(3,He,13,6,"ng-template",3),e.qZA()),2&t&&e.Q6J("value",i.orderBoxes)},directives:[f.iA,b.jx,C.zx,f.D$,f.YL,S.R,a.JJ,a.On,a.Q7,m.O5,f.Pv,f.U1,f.wT],styles:[""]}),n})();function je(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",51),e.NdJ("onClick",function(){e.CHM(t);const o=e.oxw(2);return o.getOffer(o.clientEntity)}),e.qZA()}}function Re(n,u){if(1&n&&e._UZ(0,"p-tag",52),2&n){const t=e.oxw(2);e.Q6J("value",t.getStatus(t.order.status).label)("severity",t.getStatus(t.order.status).severity)}}function $e(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-dropdown",53),e.NdJ("onHide",function(){return e.CHM(t),e.oxw(),e.MAs(16).deactivate()})("ngModelChange",function(o){return e.CHM(t),e.oxw(2).order.status=o}),e.qZA()}if(2&n){const t=e.oxw(2);e.Q6J("options",t.statusDropdown)("autoDisplayFirst",!1)("ngModel",t.order.status)}}function Le(n,u){if(1&n&&(e.TgZ(0,"div",13)(1,"div"),e._uU(2,"\u0416\u0435\u043b\u0430\u0435\u043c\u0430\u044f \u0434\u0430\u0442\u0430 \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438:"),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.ALo(5,"date"),e.ALo(6,"date"),e.qZA()()),2&n){const t=e.oxw(2);e.xp6(4),e.lnq(" ",e.xi3(5,3,t.order.deliveryWishDateFrom,"dd.MM.yyyy")," ",t.order.deliveryWishDateTo?"-":""," ",e.xi3(6,6,t.order.deliveryWishDateTo,"dd.MM.yyyy")," ")}}function Ve(n,u){if(1&n&&(e._uU(0),e.ALo(1,"date")),2&n){const t=e.oxw(3);e.hij(" ",e.xi3(1,1,t.order.confirmedDeliveryDate,"dd.MM.yyyy")," ")}}function Ge(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",55)(1,"span",34)(2,"p-calendar",56,57),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw(3).order.confirmedDeliveryDate=o}),e.qZA(),e.TgZ(4,"label",58),e._uU(5,"\u0414\u0430\u0442\u0430 \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA()(),e.TgZ(6,"p-button",59),e.NdJ("onClick",function(){return e.CHM(t),e.oxw(),e.MAs(2).deactivate()}),e.qZA()()}if(2&n){const t=e.oxw(3);e.xp6(2),e.Q6J("ngModel",t.order.confirmedDeliveryDate)("firstDayOfWeek",1)("showTime",!1)("showSeconds",!1)("readonlyInput",!0)}}function ze(n,u){1&n&&(e.TgZ(0,"div")(1,"p-inplace",null,54),e.YNc(3,Ve,2,4,"ng-template",11),e.YNc(4,Ge,7,5,"ng-template",12),e.qZA()())}function We(n,u){1&n&&e._uU(0," \u0421\u043e\u0433\u043b\u0430\u0441\u043e\u0432\u0430\u0442\u044c ")}function Ke(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",55)(1,"span",34),e._UZ(2,"p-calendar",61,57),e.TgZ(4,"label",58),e._uU(5,"\u0414\u0430\u0442\u0430 \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA()(),e.TgZ(6,"p-button",62),e.NdJ("onClick",function(){e.CHM(t),e.oxw();const o=e.MAs(1);return e.oxw(2).confirmDate(o)}),e.qZA()()}if(2&n){const t=e.oxw(3);e.xp6(2),e.Q6J("formControl",t.confirmedDate)("firstDayOfWeek",1)("showTime",!1)("showSeconds",!1)("readonlyInput",!0)}}function Xe(n,u){1&n&&(e.TgZ(0,"p-inplace",null,60),e.YNc(2,We,1,0,"ng-template",11),e.YNc(3,Ke,7,5,"ng-template",12),e.qZA())}function et(n,u){if(1&n&&e._uU(0),2&n){const t=e.oxw(2);e.hij(" ",t.order.clientAddress," ")}}function tt(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",55)(1,"span",34)(2,"input",63),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw(2).order.clientAddress=o}),e.qZA(),e.TgZ(3,"label",64),e._uU(4,"\u0410\u0434\u0440\u0435\u0441"),e.qZA()(),e.TgZ(5,"p-button",65),e.NdJ("onClick",function(){return e.CHM(t),e.oxw(),e.MAs(36).deactivate()}),e.qZA()()}if(2&n){const t=e.oxw(2);e.xp6(2),e.Q6J("ngModel",t.order.clientAddress)}}function nt(n,u){if(1&n&&(e.TgZ(0,"div",18)(1,"div"),e._uU(2,"\u0421\u043a\u0438\u0434\u043a\u0430:"),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.ALo(5,"priceConverter"),e.qZA()()),2&n){const t=e.oxw(2);e.xp6(4),e.AsE("",e.lcZ(5,2,t.orderDiscount.value)," (",t.orderDiscount.percent,"%)")}}function it(n,u){if(1&n&&(e._uU(0),e.ALo(1,"priceConverter")),2&n){const t=e.oxw(2);e.hij(" ",e.lcZ(1,1,t.order.deliveryPrice)," ")}}function ot(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",55)(1,"span",34)(2,"p-inputNumber",66),e.NdJ("ngModelChange",function(o){return e.CHM(t),e.oxw(2).order.deliveryPrice=o}),e.qZA(),e.TgZ(3,"label",67),e._uU(4,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA()(),e.TgZ(5,"p-button",65),e.NdJ("onClick",function(){return e.CHM(t),e.oxw(),e.MAs(57).deactivate()}),e.qZA()()}if(2&n){const t=e.oxw(2);e.xp6(2),e.Q6J("ngModel",t.order.deliveryPrice)("min",1)("disabled",t.isDeliveryDistribute)}}function rt(n,u){if(1&n&&(e.TgZ(0,"div",68)(1,"div"),e._uU(2,"\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439:"),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.qZA()()),2&n){const t=e.oxw(2);e.xp6(4),e.Oqu(t.order.comment)}}function ut(n,u){if(1&n&&(e.TgZ(0,"div")(1,"div",69)(2,"div"),e._uU(3,"\u041d\u0430\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u0435 \u044e\u0440\u0438\u0434\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043b\u0438\u0446\u0430:"),e.qZA(),e.TgZ(4,"div"),e._uU(5),e.qZA()(),e.TgZ(6,"div",70)(7,"div"),e._uU(8,"\u0418\u041d\u041d:"),e.qZA(),e.TgZ(9,"div"),e._uU(10),e.qZA()()()),2&n){const t=e.oxw(2);e.xp6(5),e.Oqu(t.clientEntity.ShortName),e.xp6(5),e.Oqu(t.clientEntity.INN)}}function st(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",71)(1,"p-button",72),e.NdJ("onClick",function(){return e.CHM(t),e.oxw(2).openTelepack()}),e.qZA()()}}function ct(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",73)(1,"flower-valley-boxes-order",74),e.NdJ("orderBoxesChange",function(o){return e.CHM(t),e.oxw(2).order.boxes=o}),e.qZA()()}if(2&n){const t=e.oxw(2);e.xp6(1),e.Q6J("orderBoxes",t.order.boxes)("products",t.order.products)}}function dt(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div",1)(1,"div",2)(2,"span",3),e.YNc(3,je,1,0,"p-button",4),e.TgZ(4,"p-button",5),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().getEstimate()}),e.qZA(),e.TgZ(5,"p-button",6),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().repeatOrder()}),e.qZA(),e.TgZ(6,"p-button",7),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().confirmSaving()}),e.qZA()()(),e.TgZ(7,"div",8)(8,"div")(9,"div",9)(10,"div"),e._uU(11,"\u041d\u043e\u043c\u0435\u0440 \u0437\u0430\u043a\u0430\u0437\u0430:"),e.qZA(),e.TgZ(12,"div")(13,"span"),e._uU(14),e.qZA(),e.TgZ(15,"p-inplace",null,10),e.YNc(17,Re,1,2,"ng-template",11),e.YNc(18,$e,1,3,"ng-template",12),e.qZA()()(),e.TgZ(19,"div",13)(20,"div"),e._uU(21,"\u0414\u0430\u0442\u0430 \u0437\u0430\u043a\u0430\u0437\u0430:"),e.qZA(),e.TgZ(22,"div"),e._uU(23),e.ALo(24,"date"),e.qZA()(),e.YNc(25,Le,7,9,"div",14),e.TgZ(26,"div",13)(27,"div"),e._uU(28,"\u0414\u0430\u0442\u0430 \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438:"),e.qZA(),e.YNc(29,ze,5,0,"div",15),e.YNc(30,Xe,4,0,"p-inplace",15),e.qZA(),e.TgZ(31,"div",16)(32,"div"),e._uU(33,"\u0410\u0434\u0440\u0435\u0441 \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438:"),e.qZA(),e.TgZ(34,"div")(35,"p-inplace",null,17),e.YNc(37,et,1,1,"ng-template",11),e.YNc(38,tt,6,1,"ng-template",12),e.qZA()()(),e.TgZ(39,"div",18)(40,"div"),e._uU(41,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c \u0442\u043e\u0432\u0430\u0440\u043e\u0432:"),e.qZA(),e.TgZ(42,"div"),e._uU(43),e.ALo(44,"priceConverter"),e.qZA()(),e.YNc(45,nt,6,4,"div",19),e.TgZ(46,"div",20)(47,"div"),e._uU(48,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c \u043a\u043e\u0440\u043e\u0431\u043e\u043a:"),e.qZA(),e.TgZ(49,"div"),e._uU(50),e.ALo(51,"priceConverter"),e.qZA()(),e.TgZ(52,"div",21)(53,"div"),e._uU(54,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c \u043f\u043e\u0441\u0442\u0430\u0432\u043a\u0438:"),e.qZA(),e.TgZ(55,"div")(56,"p-inplace",null,22),e.YNc(58,it,2,3,"ng-template",11),e.YNc(59,ot,6,3,"ng-template",12),e.qZA()()(),e.TgZ(60,"div",23)(61,"div"),e._uU(62,"\u0421\u0443\u043c\u043c\u0430 \u0437\u0430\u043a\u0430\u0437\u0430:"),e.qZA(),e.TgZ(63,"div"),e._uU(64),e.ALo(65,"priceConverter"),e.qZA()(),e.YNc(66,rt,5,1,"div",24),e.qZA(),e.TgZ(67,"div",25)(68,"div",26)(69,"div"),e._uU(70,"\u041a\u043b\u0438\u0435\u043d\u0442:"),e.qZA(),e.TgZ(71,"div"),e._uU(72),e.qZA()(),e.TgZ(73,"div",27)(74,"div"),e._uU(75,"\u0422\u0435\u043b\u0435\u0444\u043e\u043d:"),e.qZA(),e.TgZ(76,"div"),e._uU(77),e.qZA()(),e.TgZ(78,"div",28)(79,"div"),e._uU(80,"\u041f\u043e\u0447\u0442\u0430:"),e.qZA(),e.TgZ(81,"div"),e._uU(82),e.qZA()()()(),e.TgZ(83,"div",29),e.YNc(84,ut,11,2,"div",15),e.YNc(85,st,2,0,"div",30),e.qZA(),e.TgZ(86,"p-accordion",31)(87,"p-accordionTab",32)(88,"div",33)(89,"div")(90,"span",34),e._UZ(91,"p-dropdown",35,36),e.TgZ(93,"label",37),e._uU(94,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u0435"),e.qZA()(),e.TgZ(95,"span",34),e._UZ(96,"p-inputNumber",38,39),e.TgZ(98,"label",40),e._uU(99,"\u0417\u043d\u0430\u0447\u0435\u043d\u0438\u0435, %"),e.qZA()(),e.TgZ(100,"p-button",41),e.NdJ("onClick",function(){e.CHM(t);const o=e.MAs(92),r=e.MAs(97);return e.oxw().changeOrderSum(o.value,r.value)}),e.qZA(),e.TgZ(101,"p-button",42),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().cancelChangeOrderSum()}),e.qZA()(),e.TgZ(102,"div",43)(103,"p-button",44),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().distributeBoxesPrice()}),e.qZA(),e.TgZ(104,"p-button",45),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().distributeDeliveryPrice()}),e.qZA()()(),e.TgZ(105,"div",46)(106,"p-button",47),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().saveCalculatedOrder()}),e.qZA()()()(),e.TgZ(107,"div",48)(108,"flower-valley-products-order",49),e.NdJ("orderProductsChange",function(o){return e.CHM(t),e.oxw().order.products=o}),e.qZA()(),e.YNc(109,ct,2,2,"div",50),e.qZA()}if(2&n){const t=e.oxw();e.xp6(3),e.Q6J("ngIf",t.clientEntity),e.xp6(1),e.Q6J("disabled",!t.order.confirmedDeliveryDate),e.xp6(2),e.Q6J("loading",t.sendingMail),e.xp6(8),e.hij(" ",t.order.id," "),e.xp6(9),e.Oqu(e.xi3(24,23,t.order.orderDate,"dd.MM.yyyy HH:mm")),e.xp6(2),e.Q6J("ngIf",!t.order.confirmedDeliveryDate&&t.order.deliveryWishDateFrom),e.xp6(4),e.Q6J("ngIf",t.order.confirmedDeliveryDate),e.xp6(1),e.Q6J("ngIf",!t.order.confirmedDeliveryDate),e.xp6(13),e.Oqu(e.lcZ(44,26,t.getProductsSum())),e.xp6(2),e.Q6J("ngIf",t.orderDiscount),e.xp6(5),e.Oqu(e.lcZ(51,28,t.getBoxesSum())),e.xp6(14),e.Oqu(e.lcZ(65,30,t.getOrderSum())),e.xp6(2),e.Q6J("ngIf",t.order.comment),e.xp6(6),e.Oqu(t.order.clientName),e.xp6(5),e.Oqu(t.order.clientPhone),e.xp6(5),e.Oqu(t.order.clientEmail),e.xp6(2),e.Q6J("ngIf",t.clientEntity&&t.clientEntity.INN),e.xp6(1),e.Q6J("ngIf",null==t.order?null:t.order.accountNumber),e.xp6(6),e.Q6J("options",t.calculateOptions),e.xp6(5),e.Q6J("min",1),e.xp6(10),e.Q6J("loading",t.sendingMail),e.xp6(2),e.Q6J("orderProducts",t.order.products),e.xp6(1),e.Q6J("ngIf",!t.isBoxesDistribute)}}let lt=(()=>{class n{constructor(t,i,o,r,s,c,p,l,_,g,v,h,y,x,Tt){this.orderService=t,this.bpService=i,this.estimatePDF=o,this.priceConvert=r,this.dateConvert=s,this.dateConverter=c,this.mailService=p,this.documentService=l,this.offerService=_,this.route=g,this.router=v,this.fb=h,this.ms=y,this.cs=x,this.ls=Tt,this.currentDate=new Date,this.products=[],this.sendingMail=!1,this.sendMail=!1,this.statusDropdown=A.hm,this.calculateOptions=[{name:"\u041f\u043e\u043d\u0438\u0437\u0438\u0442\u044c",value:Z.DownGrade},{name:"\u041f\u043e\u0432\u044b\u0441\u0438\u0442\u044c",value:Z.UpGrade}],this.isBoxesDistribute=!1,this.isDeliveryDistribute=!1,this.isOrderCalculated=!1,g.params.subscribe(Zt=>{this.orderId=Zt.id}),this.confirmedDate=h.control(null)}ngOnInit(){if(this.orderId){const t=this.orderService.getItemById(this.orderId).subscribe(i=>{this.order=Object.assign(Object.assign({},i),{confirmedDeliveryDate:i.confirmedDeliveryDate?this.dateConverter.convert(i.confirmedDeliveryDate):void 0,deliveryWishDateFrom:i.deliveryWishDateFrom?this.dateConverter.convert(i.deliveryWishDateFrom):void 0,deliveryWishDateTo:i.deliveryWishDateTo?this.dateConverter.convert(i.deliveryWishDateTo):void 0});let o={value:0,percent:0},r=0;if(this.order.products.map(s=>{const c=s.product.price-s.price;c>0&&(o.value+=c*s.count),r+=s.price*s.count}),o&&(this.orderDiscount=o,this.orderDiscount.percent=Math.round(this.orderDiscount.value/(this.orderDiscount.value+r)*100)),this.order.deliveryWishDateFrom&&this.confirmedDate.setValue(new Date(this.dateConverter.convert(i.deliveryWishDateFrom))),this.order.clientId){const s=this.bpService.getFirmById(this.order.clientId).subscribe(c=>{this.clientEntity=c,this.ls.removeSubscription(s)});this.ls.addSubscription(s)}if(this.ls.removeSubscription(t),this.order.invoiceId){const s=this.bpService.getInvoiceById(this.order.invoiceId).subscribe(c=>{this.invoiceNumber=c.Name,this.ls.removeSubscription(s)},()=>{this.ms.add({severity:"error",summary:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u043d\u043e\u043c\u0435\u0440\u0430 \u0441\u0447\u0451\u0442\u0430",detail:"\u0421\u0447\u0451\u0442 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d",life:5e3}),this.ls.removeSubscription(s)});this.ls.addSubscription(s)}this.order.status===w.i.New&&(this.order.status=w.i.In_Process)});this.ls.addSubscription(t)}}saveOrder(){const t=Object.assign({},this.order);if(t.products=this.order.products.map(i=>({id:i.product.id,count:i.count,price:i.price})),t&&t.confirmedDeliveryDate&&(t.confirmedDeliveryDate=t.confirmedDeliveryDate.toISOString()),t.boxes=this.order.boxes.map(i=>({id:i.box.id,count:i.count,price:i.price})),t.requestNumber||delete t.requestNumber,t.accountNumber||delete t.accountNumber,t.invoiceId||delete t.invoiceId,t.clientId||delete t.clientId,t.clientInn||delete t.clientInn,t.orderSum=this.getOrderSum(),t.deliveryPrice&&this.order&&this.order.status===w.i.Calculate_Delivery&&(this.order.status=w.i.In_Process,t.status=this.order.status),this.isOrderCalculated)t.id&&(this.orderService.updateItem({id:t.id,status:w.i.Calculated}).subscribe(),delete t.id),t.orderDate&&delete t.orderDate,this.orderService.addItem(t).subscribe(i=>{var o;null===(o=this.order)||void 0===o||(o.id=i),this.sendMail?this.sendInvoiceMail(this.order.invoiceId,this.order.clientId,this.order.id,!!t.clientInn):(this.sendingMail=!1,this.router.navigate(["admin/orders"]))});else{const i=this.orderService.updateItem(t).subscribe(()=>{this.sendMail?this.sendInvoiceMail(this.order.invoiceId,this.order.clientId,this.order.id,!!t.clientInn):(this.sendingMail=!1,this.ms.add({severity:"success",summary:"\u0417\u0430\u043a\u0430\u0437 \u0438\u0437\u043c\u0435\u043d\u0435\u043d",detail:"\u0414\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0435"})),this.ls.removeSubscription(i)});this.ls.addSubscription(i)}}getStatus(t){return(0,A.SX)(t)}repeatOrder(){var t;this.router.navigate(["admin/orders/create"],{queryParams:{orderId:null===(t=this.order)||void 0===t?void 0:t.id}})}getOrderSum(){let t=0;return this.order&&(t+=this.order.deliveryPrice,t+=this.getProductsSum(),t+=this.getBoxesSum()),t}getProductsSum(){let t=0;return this.order&&this.order.products.map(i=>{t+=i.price*i.count}),t}getBoxesSum(){let t=0;return this.order&&this.order.boxes.map(i=>{t+=i.price*i.count}),t}getDocumentBoxes(){const t=[];return this.order&&this.order.boxes.map(i=>{t.push({name:i.box.name,price:i.price,count:i.count})}),t}openTelepack(){var t;window.open("https://375.ru/"+(null===(t=this.order)||void 0===t?void 0:t.accountNumber))}getEstimate(){this.order&&this.estimatePDF.getCompanyPDF(this.order.products.sort((t,i)=>{var o,r;return((null===(o=t.product.category)||void 0===o?void 0:o.id)||t.product.categoryId)-((null===(r=i.product.category)||void 0===r?void 0:r.id)||i.product.categoryId)}).map(t=>[t.product.name,t.price,t.count,t.price*t.count]),this.priceConvert.transform(this.order.deliveryPrice||0,"two","none"),this.getDocumentBoxes(),this.priceConvert.transform(this.getProductsSum(),"two","rub"),this.priceConvert.transform(this.getOrderSum(),"two","none"),this.order,this.dateConvert.transform(this.order.confirmedDeliveryDate,"dd.MM.yyyy"),this.invoiceNumber)}confirmDate(t){t.deactivate(),this.order.confirmedDeliveryDate=this.confirmedDate.value}confirmSaving(){this.sendMail=!1,this.cs.confirm({header:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430",message:"\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u043f\u043e\u0441\u043e\u0431 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f",acceptLabel:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u043f\u0438\u0441\u044c\u043c\u043e \u043a\u043b\u0438\u0435\u043d\u0442\u0443",acceptIcon:"pi pi-times",rejectLabel:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0431\u0435\u0437 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438 \u043f\u0438\u0441\u044c\u043c\u0430",accept:()=>{if(this.sendMail=!0,this.order&&this.order.invoiceId){const t=this.bpService.deleteInvoice(this.order.invoiceId).subscribe(()=>{this.ls.removeSubscription(t),this.createInvoice()});this.ls.addSubscription(t)}else this.createInvoice()},reject:t=>{switch(t){case b.wB.REJECT:this.sendMail=!1,this.saveOrder();break;case b.wB.CANCEL:this.ms.add({severity:"warn",summary:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u043e\u0442\u043c\u0435\u043d\u0435\u043d\u043e",detail:"\u0412\u044b \u043e\u0442\u043c\u0435\u043d\u0438\u043b\u0438 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430"})}}})}createInvoice(){var t,i,o;const r=[];if(this.orderService.generateOrderProducts((null===(t=this.order)||void 0===t?void 0:t.products)||[]).map(s=>{r.push({volume_id:s.volume||"",model_name:s.name,qname:s.name,nds:0,nds_mode:0,count:s.count,price:s.price})}),this.orderService.generateInvoiceBoxes((null===(i=this.order)||void 0===i?void 0:i.boxes)||[]).map(s=>{r.push({model_id:this.bpService.boxId,volume_id:this.bpService.boxVolume,nds:0,nds_mode:0,count:s.count,price:s.price,qname:s.name})}),this.order.deliveryPrice&&r.push({model_id:this.bpService.deliveryId,volume_id:this.bpService.deliveryVolume,nds:0,nds_mode:0,count:1,price:this.order.deliveryPrice,qname:"\u0414\u043e\u0441\u0442\u0430\u0432\u043a\u0430"}),this.order&&!this.order.clientId){const s=this.createIndividualEntity().subscribe(c=>{this.ls.removeSubscription(s),this.bpRequest(r,c)});this.ls.addSubscription(s)}else this.bpRequest(r,null===(o=this.order)||void 0===o?void 0:o.clientId)}bpRequest(t,i){const s=this.bpService.createInvoice({firm_id:this.bpService.selfId,partner_id:i,goods:t,partner_flag:"A"}).subscribe(c=>{const p=c.Object;this.order.invoiceId=p;const l=this.bpService.sendInvoiceToTelepak(p,{report_name:"\u0421\u0447\u0435\u0442 \u0441 \u043e\u0431\u0440\u0430\u0437\u0446\u043e\u043c \u043f. \u043f. + \u043f\u0435\u0447\u0430\u0442\u044c \u043f\u043e\u0434\u043f\u0438\u0441\u044c",send_with_stamp:!0}).subscribe(({id:_})=>{this.ls.removeSubscription(l),_&&(this.order.accountNumber=_,this.saveOrder())});this.ls.addSubscription(l),this.ls.removeSubscription(s)});this.ls.addSubscription(s)}createIndividualEntity(){var t,i,o;return this.bpService.createFirm({FullName:null===(t=this.order)||void 0===t?void 0:t.clientName,Address:`${this.order&&this.order.clientAddress?this.order.clientAddress+",":""} ${null===(i=this.order)||void 0===i?void 0:i.clientPhone}, ${null===(o=this.order)||void 0===o?void 0:o.clientEmail}`}).pipe((0,N.U)(r=>(this.order.clientId=r.Object,r.Object)))}sendInvoiceMail(t,i,o,r){const s=[this.bpService.getInvoiceById(t),this.bpService.getFirmById(i),this.orderService.getItemById(o)],c=(0,Y.D)(s).subscribe(([p,l,_])=>{p=p,l=l;const g=_,v=new FormData;if(v.append("billNumber",p.Name),v.append("billDate",p.Date),v.append("accountNumber",g.accountNumber),v.append("email",g.clientEmail),v.append("orderId",o.toString()),r){const h=this.documentService.getOffer(g,l).subscribe(y=>{h.unsubscribe(),v.append("file",y);const x=this.mailService.sendBusinessMail(v,g,l.FullName).subscribe(()=>{this.ls.removeSubscription(x),this.ms.add({severity:"success",summary:"\u0417\u0430\u043a\u0430\u0437 \u0438\u0437\u043c\u0435\u043d\u0435\u043d",detail:`\u041e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u0437\u0430\u043a\u0430\u0437\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u0430 \u043f\u043e\u0447\u0442\u0443 ${g.clientEmail}`})});this.ls.addSubscription(x)})}else{const h=this.mailService.sendIndividualMail(v,g).subscribe(()=>{this.ls.removeSubscription(h),this.ms.add({severity:"success",summary:"\u0417\u0430\u043a\u0430\u0437 \u0438\u0437\u043c\u0435\u043d\u0435\u043d",detail:`\u041e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u0437\u0430\u043a\u0430\u0437\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u0430 \u043f\u043e\u0447\u0442\u0443 ${g.clientEmail}`})});this.ls.addSubscription(h)}this.ls.removeSubscription(c)});this.ls.addSubscription(c)}changeOrderSum(t,i){var o,r;const s=i/100;switch(t){case Z.DownGrade:null===(o=this.order)||void 0===o||o.products.map(c=>{c.initialPrice||(c.initialPrice=c.price),c.price-=Number((c.price*s).toFixed(2))});break;case Z.UpGrade:null===(r=this.order)||void 0===r||r.products.map(c=>{c.initialPrice||(c.initialPrice=c.price),c.price+=Number((c.price*s).toFixed(2))})}}cancelChangeOrderSum(){var t;null===(t=this.order)||void 0===t||t.products.map(i=>{i.initialPrice&&(i.price=i.initialPrice,delete i.initialPrice)})}distributeDeliveryPrice(){if(this.order){const t=this.order.products.length,i=this.order.deliveryPrice/t;let o=0;for(let r=0;r<t;r++){const s=this.order.products[r];if(r===t-1)s.price+=Number(((this.order.deliveryPrice-o)/s.count).toFixed(2));else{const c=Number((i/s.count).toFixed(2));o+=c*s.count,s.price+=c}}this.order.deliveryPrice=0,this.isDeliveryDistribute=!0}}distributeBoxesPrice(){if(this.order){const t=this.order.products.length,i=this.getBoxesSum()/t;let o=0;for(let r=0;r<t;r++){const s=this.order.products[r];if(r===t-1)s.price+=Number(((this.getBoxesSum()-o)/s.count).toFixed(2));else{const c=Number((i/s.count).toFixed(2));o+=c*s.count,s.price+=c}}this.order.boxes=[],this.isBoxesDistribute=!0}}saveCalculatedOrder(){var t;this.isOrderCalculated=!0,(null===(t=this.order)||void 0===t?void 0:t.clientId)?this.createInvoice():this.saveOrder()}getOffer(t){var i;let o="";o+=t.FullName,o+=`, ${t.Address}`,o+=`, \u0418\u041d\u041d: ${t.INN}`,t.KPP&&(o+=`, \u041a\u041f\u041f: ${t.KPP}`);const r=this.order.id,s=new Date(this.order.orderDate).toLocaleDateString()+"\u0433.";let c=0;const p=this.order.products.map(l=>(c+=l.count*l.price,[l.product.name,"\u0448\u0442.",l.count,this.priceConvert.transform(l.price,"two","none"),this.priceConvert.transform(l.count*l.price,"two","none")]));(null===(i=this.order)||void 0===i?void 0:i.deliveryPrice)&&(c+=this.order.deliveryPrice,p.push(["\u0414\u043e\u0441\u0442\u0430\u0432\u043a\u0430","-",1,this.priceConvert.transform(this.order.deliveryPrice,"two","none"),this.priceConvert.transform(this.order.deliveryPrice,"two","none")])),this.offerService.getPDF(r,s,o,p,c)}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(P.p),e.Y36(Q.k),e.Y36(k.h),e.Y36(I.K),e.Y36(m.uU),e.Y36(U),e.Y36(H.Y),e.Y36(M.M),e.Y36(Ce.u),e.Y36(T.gz),e.Y36(T.F0),e.Y36(a.qu),e.Y36(b.ez),e.Y36(b.YP),e.Y36(j.b))},n.\u0275cmp=e.Xpm({type:n,selectors:[["flower-valley-order"]],features:[e._Bn([k.h,I.K,m.uU,U,M.M])],decls:1,vars:1,consts:[["class","order",4,"ngIf"],[1,"order"],[1,"order__actions"],[1,"p-buttonset"],["icon","pi pi-file","label","\u041a\u041f",3,"onClick",4,"ngIf"],["icon","pi pi-download","label","\u0421\u043c\u0435\u0442\u0430",3,"disabled","onClick"],["icon","pi pi-sync","styleClass","p-button-info","label","\u041f\u043e\u0432\u0442\u043e\u0440\u0438\u0442\u044c",3,"onClick"],["icon","pi pi-save","label","\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c",3,"loading","onClick"],[1,"order__header"],[1,"order__header_id"],["statusInplace",""],["pTemplate","display"],["pTemplate","content"],[1,"order__header_date"],["class","order__header_date",4,"ngIf"],[4,"ngIf"],[1,"order__header_address"],["addressInplace",""],[1,"order__header_products-sum"],["class","order__header_products-sum",4,"ngIf"],[1,"order__header_boxes-sum"],[1,"order__header_delivery"],["deliveryInplace",""],[1,"order__header_sum"],["class","order__header_comment",4,"ngIf"],[1,"order__client"],[1,"order__client_name"],[1,"order__client_phone"],[1,"order__client_email"],[1,"order__entity"],["class","order__entity_account",4,"ngIf"],["styleClass","mt-4"],["header","\u041a\u0430\u043b\u044c\u043a\u0443\u043b\u044f\u0446\u0438\u044f \u0437\u0430\u043a\u0430\u0437\u0430"],[1,"flex","justify-content-between"],[1,"p-float-label"],["inputId","dropdown","optionLabel","name","optionValue","value",3,"options"],["dropdown",""],["for","dropdown"],["inputId","percentValue",3,"min"],["inputNumber",""],["for","percentValue"],["label","\u0420\u0430\u0441\u0447\u0438\u0442\u0430\u0442\u044c",3,"onClick"],["styleClass","p-button-danger ml-2","label","\u0421\u0431\u0440\u043e\u0441\u0438\u0442\u044c",3,"onClick"],[1,"flex","flex-column"],["styleClass","mb-2","label","\u0420\u0430\u0441\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u043a\u043e\u0440\u043e\u0431\u043a\u0438",3,"onClick"],["label","\u0420\u0430\u0441\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0443",3,"onClick"],[1,"flex","justify-content-center"],["label","\u041e\u0444\u043e\u0440\u043c\u0438\u0442\u044c",3,"loading","onClick"],[1,"order__products"],[3,"orderProducts","orderProductsChange"],["class","order__boxes",4,"ngIf"],["icon","pi pi-file","label","\u041a\u041f",3,"onClick"],[3,"value","severity"],["placeholder","\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u0443\u0441","optionLabel","name","optionValue","value",3,"options","autoDisplayFirst","ngModel","onHide","ngModelChange"],["inplace",""],[1,"flex","align-items-center"],["dateFormat","dd.mm.yy","inputId","confirmedDate",3,"ngModel","firstDayOfWeek","showTime","showSeconds","readonlyInput","ngModelChange"],["calendar",""],["for","confirmedDate"],["styleClass","ml-2","label","\u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c",3,"onClick"],["dateInplace",""],["dateFormat","dd.mm.yy","inputId","confirmedDate",3,"formControl","firstDayOfWeek","showTime","showSeconds","readonlyInput"],["styleClass","ml-2","label","\u0421\u043e\u0433\u043b\u0430\u0441\u043e\u0432\u0430\u0442\u044c",3,"onClick"],["type","text","id","address","pInputText","",3,"ngModel","ngModelChange"],["for","address"],["styleClass","ml-2","label","\u0417\u0430\u043a\u0440\u044b\u0442\u044c",3,"onClick"],["inputId","delivery",3,"ngModel","min","disabled","ngModelChange"],["for","delivery"],[1,"order__header_comment"],[1,"order__entity_name"],[1,"order__entity_inn"],[1,"order__entity_account"],["label","\u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u0441\u0447\u0435\u0442",3,"onClick"],[1,"order__boxes"],[3,"orderBoxes","products","orderBoxesChange"]],template:function(t,i){1&t&&e.YNc(0,dt,110,32,"div",0),2&t&&e.Q6J("ngIf",i.order)},directives:[m.O5,C.zx,F,b.jx,J,D.Lt,a.JJ,a.On,R.f,a.oH,a.Fj,O.o,S.R,E.UQ,E.US,L,G],pipes:[m.uU,I.K],styles:[".order[_ngcontent-%COMP%]{padding-top:20px}.order__actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;padding-bottom:10px}.order__header[_ngcontent-%COMP%], .order__entity[_ngcontent-%COMP%]{display:flex;justify-content:space-between}.order__header[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%], .order__entity[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{display:flex;align-items:center;padding-bottom:10px}.order__header[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:first-child, .order__entity[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:first-child{margin-right:10px;font-weight:500}.order__header_id[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{display:flex;align-items:center}.order__header_id[_ngcontent-%COMP%] > div[_ngcontent-%COMP%] > span[_ngcontent-%COMP%]{padding-right:10px}.order__entity[_ngcontent-%COMP%], .order__products[_ngcontent-%COMP%], .order__boxes[_ngcontent-%COMP%]{padding-top:20px}"]}),n})();var z=d(7613),at=d(9646),pt=d(3710),_t=d(3058);function mt(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"div")(1,"flower-valley-entity-form",22),e.NdJ("dataChanges",function(o){return e.CHM(t),e.oxw().entityDataChanges(o)}),e.qZA()()}if(2&n){const t=e.oxw();e.xp6(1),e.Q6J("isNewOrder",!0)("client",t.entity)}}function gt(n,u){if(1&n){const t=e.EpF();e.TgZ(0,"p-button",23),e.NdJ("onClick",function(){return e.CHM(t),e.oxw().createOrder()}),e.qZA()}}const ht=[{path:"",component:be},{path:"create",component:(()=>{class n{constructor(t,i,o,r,s,c,p,l,_,g){this.orderService=t,this.productService=i,this.bpService=o,this.mailService=r,this.documentService=s,this.fb=c,this.ls=p,this.route=l,this.router=_,this.ms=g,this.products=[],this.boxes=[],this.isEntityDataChanged=!1,this.contactsGroup=c.group({requestNumber:[""],clientName:["",a.kI.required],clientPhone:["",a.kI.required],clientEmail:["",a.kI.required],clientAddress:[""],deliveryPrice:[0]}),l.queryParams.subscribe(v=>{this.orderId=v.orderId})}ngOnInit(){if(this.orderId){const t=this.orderService.getItemById(this.orderId).subscribe(i=>{if(this.products=i.products,this.boxes=i.boxes,this.order=i,this.contactsGroup.patchValue(i),i.clientId){const o=this.bpService.getFirmById(i.clientId).subscribe(r=>{this.entity=r,this.ls.removeSubscription(o)});this.ls.addSubscription(o)}this.ls.removeSubscription(t)});this.ls.addSubscription(t)}}entityDataChanges(t){n.instanceOfId(t)?(this.entityId=t.id,this.isEntityDataChanged=t.isChanged):(this.entityData=t,this.isEntityDataChanged||(this.entityId=void 0))}static instanceOfId(t){return"id"in t}createOrder(){var t;if((0,z.F)(this.contactsGroup))return;const i=this.getOrderData();if(i.requestNumber||(null===(t=this.order)||void 0===t?void 0:t.clientId)){if((0,z.F)(this.entityData))return;this.entityData.disable(),this.createInvoice(i)}else{const o=[];i.products.map(s=>{o.push({id:s.product.id,count:s.count,price:s.price})});const r=this.orderService.addItem(Object.assign(Object.assign({},i),{products:o})).subscribe(s=>{this.sendIndividualMail(s),this.ls.removeSubscription(r)},({error:s})=>{this.ms.add({severity:"error",summary:"\u0427\u0442\u043e-\u0442\u043e \u043f\u043e\u0448\u043b\u043e \u043d\u0435 \u0442\u0430\u043a",detail:s.message})});this.ls.addSubscription(r)}}getOrderData(){const t=this.contactsGroup.getRawValue();let i=[];this.boxes.map(r=>{i.push({id:r.box.id,price:r.price,count:r.count})});const o={clientEmail:t.clientEmail,clientName:t.clientName,clientPhone:t.clientPhone,clientAddress:t.clientAddress?t.clientAddress:"\u0421\u0430\u043c\u043e\u0432\u044b\u0432\u043e\u0437",products:this.products,boxes:i,deliveryPrice:t.deliveryPrice,orderSum:this.getOrderSum()};return t.requestNumber&&(o.requestNumber=t.requestNumber),o}createInvoice(t){this.getPartner().subscribe(({partnerId:i,inn:o})=>{if(i){t.clientId=i,t.clientInn=o;const r=this.bpService.selfId,s=[];this.order.products.map(l=>{l.product.id&&l.product.volume&&s.push({model_id:l.product.id,volume_id:l.product.volume,nds:0,nds_mode:0,count:l.count,price:l.price,qname:l.product.name})}),this.orderService.generateInvoiceBoxes(t.boxes||[]).map(l=>{s.push({model_id:this.bpService.boxId,volume_id:this.bpService.boxVolume,nds:0,nds_mode:0,count:l.count,price:l.price,qname:l.name})}),t.deliveryPrice&&s.push({model_id:this.bpService.deliveryId,volume_id:this.bpService.deliveryVolume,nds:0,nds_mode:0,count:1,price:t.deliveryPrice,qname:"\u0414\u043e\u0441\u0442\u0430\u0432\u043a\u0430"});const p=this.bpService.createInvoice({firm_id:r,partner_id:i,goods:s,partner_flag:"A"}).subscribe(l=>{const _=l.Object,g=this.bpService.sendInvoiceToTelepak(_,{report_name:"\u0421\u0447\u0435\u0442 \u0441 \u043e\u0431\u0440\u0430\u0437\u0446\u043e\u043c \u043f. \u043f. + \u043f\u0435\u0447\u0430\u0442\u044c \u043f\u043e\u0434\u043f\u0438\u0441\u044c",send_with_stamp:!0}).subscribe(({id:v})=>{if(v){t.accountNumber=v;const h=[];t.products.map(x=>{h.push({id:x.product.id,count:x.count,price:x.price})});const y=this.orderService.addItem(Object.assign(Object.assign({},t),{products:h})).subscribe(x=>{this.ls.removeSubscription(y),this.sendBusinessMail(_,i,x)});this.ls.addSubscription(y)}this.ls.removeSubscription(g)});this.ls.addSubscription(g),this.ls.removeSubscription(p)});this.ls.addSubscription(p)}})}getPartner(){return this.entityId?this.isEntityDataChanged?this.bpService.updateFirm(Object.assign(Object.assign({},this.entityData.getRawValue()),{Object:this.entityId})).pipe((0,N.U)(t=>({partnerId:t.Object,inn:this.entityData.getRawValue().INN}))):(0,at.of)({partnerId:this.entityId,inn:this.entityData.getRawValue().INN}):this.bpService.createFirm(this.entityData.getRawValue()).pipe((0,N.U)(t=>({partnerId:t.Object,inn:this.entityData.getRawValue().INN})))}sendIndividualMail(t){const i=this.orderService.getItemById(t).subscribe(o=>{const r=this.documentService.getEstimate(o).subscribe(s=>{const c=new FormData;c.append("file",s),c.append("orderId",t.toString()),c.append("email",o.clientEmail);const p=this.mailService.sendIndividualMail(c,o).subscribe(()=>{this.ls.removeSubscription(p),this.ms.add({severity:"success",summary:"\u0417\u0430\u043a\u0430\u0437 \u043e\u0444\u043e\u0440\u043c\u043b\u0435\u043d",detail:`\u0414\u0430\u043d\u043d\u044b\u0435 \u0437\u0430\u043a\u0430\u0437\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u0430 \u043f\u043e\u0447\u0442\u0443 ${o.clientEmail}`}),this.router.navigate(["admin/orders"])});this.ls.addSubscription(p),this.ls.removeSubscription(r),r.unsubscribe()});this.ls.addSubscription(r),this.ls.removeSubscription(i)});this.ls.addSubscription(i)}sendBusinessMail(t,i,o){const r=[this.bpService.getInvoiceById(t),this.bpService.getFirmById(i),this.orderService.getItemById(o)],s=(0,Y.D)(r).subscribe(([c,p,l])=>{c=c;const _=l,g=this.documentService.getOffer(_,p=p).subscribe(v=>{const h=new FormData;h.append("file",v),h.append("billNumber",c.Name),h.append("billDate",c.Date),h.append("accountNumber",_.accountNumber),_.requestNumber&&h.append("requestNumber",_.requestNumber),h.append("email",_.clientEmail);const y=this.mailService.sendBusinessMail(h,_,p.FullName).subscribe(()=>{this.ls.removeSubscription(y),this.ms.add({severity:"success",summary:"\u0417\u0430\u044f\u0432\u043a\u0430 \u043f\u0440\u0438\u043d\u044f\u0442\u0430",detail:`\u0418\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438 \u0441 \u0434\u0430\u043b\u044c\u043d\u0435\u0439\u0448\u0438\u043c\u0438 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u044f\u043c\u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u0430 \u043f\u043e\u0447\u0442\u0443 ${_.clientEmail}`}),this.router.navigate(["admin/orders"])});this.ls.addSubscription(y),this.ls.removeSubscription(g),g.unsubscribe()});this.ls.addSubscription(g),this.ls.removeSubscription(s)});this.ls.addSubscription(s)}getOrderSum(){var t;let i=0;this.boxes.map(r=>{i+=r.price*r.count}),this.products.map(r=>{i+=r.price*r.count});const o=null===(t=this.contactsGroup.get("deliveryPrice"))||void 0===t?void 0:t.value;return o&&(i+=o),i}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(P.p),e.Y36($.M),e.Y36(Q.k),e.Y36(H.Y),e.Y36(M.M),e.Y36(a.qu),e.Y36(j.b),e.Y36(T.gz),e.Y36(T.F0),e.Y36(b.ez))},n.\u0275cmp=e.Xpm({type:n,selectors:[["flower-valley-new-order"]],features:[e._Bn([M.M])],decls:34,vars:9,consts:[["headerTitle","\u041d\u043e\u0432\u044b\u0439 \u0437\u0430\u043a\u0430\u0437",3,"isAdmin","buttonTemplate"],[1,"client"],[3,"formGroup"],[1,"p-float-label"],["type","text","id","requestNumber","pInputText","","formControlName","requestNumber"],["for","requestNumber"],["type","text","id","FIO","pInputText","","formControlName","clientName"],["for","FIO"],["type","text","id","phone","pInputText","","formControlName","clientPhone"],["for","phone"],["type","text","id","email","pInputText","","formControlName","clientEmail"],["for","email"],["type","text","id","address","pInputText","","formControlName","clientAddress"],["for","address"],["id","deliveryPrice","formControlName","deliveryPrice",3,"min"],["for","deliveryPrice"],[4,"ngIf"],[1,"products"],[3,"orderProducts","isNewOrder","orderProductsChange"],[1,"boxes"],[3,"orderBoxes","products","orderBoxesChange"],["createButton",""],["newClientLabel","\u041d\u043e\u0432\u044b\u0439 \u043a\u043b\u0438\u0435\u043d\u0442",3,"isNewOrder","client","dataChanges"],["label","\u0421\u043e\u0437\u0434\u0430\u0442\u044c","icon","pi pi-plus",3,"onClick"]],template:function(t,i){if(1&t&&(e.TgZ(0,"flower-valley-container",0)(1,"div",1)(2,"form",2)(3,"span",3),e._UZ(4,"input",4),e.TgZ(5,"label",5),e._uU(6,"\u041d\u043e\u043c\u0435\u0440 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 (\u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c)"),e.qZA()(),e.TgZ(7,"span",3),e._UZ(8,"input",6),e.TgZ(9,"label",7),e._uU(10,"\u041a\u043e\u043d\u0442\u0430\u043a\u0442\u043d\u043e\u0435 \u043b\u0438\u0446\u043e"),e.qZA()(),e.TgZ(11,"span",3),e._UZ(12,"input",8),e.TgZ(13,"label",9),e._uU(14,"\u0422\u0435\u043b\u0435\u0444\u043e\u043d"),e.qZA()(),e.TgZ(15,"span",3),e._UZ(16,"input",10),e.TgZ(17,"label",11),e._uU(18,"Email"),e.qZA()(),e.TgZ(19,"span",3),e._UZ(20,"input",12),e.TgZ(21,"label",13),e._uU(22,"\u0410\u0434\u0440\u0435\u0441 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA()(),e.TgZ(23,"span",3),e._UZ(24,"p-inputNumber",14),e.TgZ(25,"label",15),e._uU(26,"\u0421\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0438"),e.qZA()()(),e.YNc(27,mt,2,2,"div",16),e.qZA(),e.TgZ(28,"div",17)(29,"flower-valley-products-order",18),e.NdJ("orderProductsChange",function(r){return i.products=r}),e.qZA()(),e.TgZ(30,"div",19)(31,"flower-valley-boxes-order",20),e.NdJ("orderBoxesChange",function(r){return i.boxes=r}),e.qZA()()(),e.YNc(32,gt,1,0,"ng-template",null,21,e.W1O)),2&t){const o=e.MAs(33);e.Q6J("isAdmin",!0)("buttonTemplate",o),e.xp6(2),e.Q6J("formGroup",i.contactsGroup),e.xp6(22),e.Q6J("min",0),e.xp6(3),e.Q6J("ngIf",i.contactsGroup.controls.requestNumber.value||(null==i.order?null:i.order.clientId)),e.xp6(2),e.Q6J("orderProducts",i.products)("isNewOrder",!0),e.xp6(2),e.Q6J("orderBoxes",i.boxes)("products",i.products)}},directives:[pt.e,a._Y,a.JL,a.sg,a.Fj,O.o,a.JJ,a.u,S.R,m.O5,_t.c,L,G,C.zx],styles:[".client[_ngcontent-%COMP%]{display:flex}.client[_ngcontent-%COMP%]   form[_ngcontent-%COMP%]{width:50%}.client[_ngcontent-%COMP%]   form[_ngcontent-%COMP%]:first-child{padding-right:20px}.client[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:50%}.calculation-result[_ngcontent-%COMP%]{position:absolute;top:15px;right:10px;font-weight:400;font-size:14px;line-height:100%}.calculation-result[_ngcontent-%COMP%]     .p-button{padding:8px 22px;font-weight:400;font-size:14px;line-height:100%}.calculation-result[_ngcontent-%COMP%]   .delivery[_ngcontent-%COMP%]{border-radius:5px;padding:8px 22px}.calculation-result[_ngcontent-%COMP%]   .delivery.success[_ngcontent-%COMP%]{border:1px solid #8FB600;color:#3a3a3a}.calculation-result[_ngcontent-%COMP%]   .delivery.error[_ngcontent-%COMP%]{border:1px solid #EA3B15;background-color:#ea3b15;color:#fff}.products[_ngcontent-%COMP%], .boxes[_ngcontent-%COMP%]{padding-top:10px}.boxes[_ngcontent-%COMP%]{padding-bottom:10px}"]}),n})()},{path:":id",component:lt}];let vt=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[T.Bz.forChild(ht)],T.Bz]}),n})();var ft=d(3275),bt=d(4466),Ct=d(2993),xt=d(8850);let yt=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({providers:[I.K],imports:[[m.ez,vt,f.U$,C.hJ,D.kW,ft.D,le,se,a.u5,B.X,bt.f,O.j,Ct.L,a.UX,R._8,E.fx,xt.$]]}),n})()}}]);